---
phase: 02-complete-agent-implementations
plan: 03
type: execute
---

<objective>
Enhance Bull/Bear agents with proper technical analysis and extract duplicate logic.

Purpose: Replace oversimplified 2% momentum detection with multi-factor technical analysis using QuantAnalyst indicators, and eliminate code duplication.
Output: Bull/Bear agents making sophisticated decisions based on RSI, MACD, Bollinger Bands, plus shared utility module.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-complete-agent-implementations/DISCOVERY.md
@.planning/phases/02-complete-agent-implementations/02-01-SUMMARY.md
@.planning/phases/02-complete-agent-implementations/02-02-SUMMARY.md

**Codebase constraints:**
- Python 3.7+ with asyncio
- Agent pattern: `async def execute(context) -> dict`
- Context contains QuantAnalyst indicators from Plan 02-01
- Bull/Bear agents vote with confidence scores [0, 1]
- DecisionCore weights votes to make final decision

**From codebase analysis (CONCERNS.md):**
- **Current issue**: Bull/Bear agents use oversimplified 2% momentum detection (`trading/agents/bull.py:47`, `bear.py:47`)
- **Duplicate logic**: Nearly identical trend detection in both agents (`bull.py:48-74`, `bear.py:48-74`)
- **Impact**: Adversarial framework makes decisions on simplistic logic instead of proper technical analysis

**From DISCOVERY.md:**
- TA-Lib indicators now available from QuantAnalyst (Plan 02-01)
- Multi-factor analysis combines RSI, MACD, Bollinger Bands for robust signals
- Bull looks for: RSI oversold, MACD bullish crossover, price near lower Bollinger Band
- Bear looks for: RSI overbought, MACD bearish crossover, price near upper Bollinger Band

**Prior work:**
- Plan 02-01 completed - QuantAnalystAgent returns real TA-Lib indicators
- Plan 02-02 completed - PredictAgent returns ML predictions
- Both provide inputs for enhanced Bull/Bear logic

**Why this matters:**
The Bull/Bear adversarial framework is the core of the 8-agent decision system. Currently they use naive 2% momentum rules that don't reflect real market dynamics. With proper technical analysis, they can provide nuanced bullish/bearish votes that DecisionCore weighs against ML predictions and risk constraints.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared momentum utility</name>
  <files>trading/utils/momentum.py (new), trading/agents/bull.py, trading/agents/bear.py</files>
  <action>
Create shared utility module for momentum calculation to eliminate duplication.

**1. Create `trading/utils/momentum.py`:**
```python
"""
Shared momentum calculation utilities for Bull/Bear agents.
Consolidates duplicate logic and provides reusable functions.
"""

def calculate_price_momentum(ohlcv, periods: int = 5):
    """
    Calculate simple price momentum over N periods.

    Args:
        ohlcv: List of OHLCV candles
        periods: Number of periods to calculate momentum over

    Returns:
        float: Momentum percentage (-1.0 to 1.0, where 1.0 = 100% gain)
    """
    if not ohlcv or len(ohlcv) < periods + 1:
        return 0.0

    current_price = float(ohlcv[-1].close)
    past_price = float(ohlcv[-(periods + 1)].close)

    if past_price == 0:
        return 0.0

    momentum = (current_price - past_price) / past_price
    return momentum

def detect_trend(ohlcv, short_period: int = 5, long_period: int = 20):
    """
    Detect price trend using short vs long period comparison.

    Args:
        ohlcv: List of OHLCV candles
        short_period: Short-term average period
        long_period: Long-term average period

    Returns:
        str: 'uptrend', 'downtrend', or 'sideways'
    """
    if not ohlcv or len(ohlcv) < long_period:
        return 'sideways'

    # Calculate simple moving averages
    recent_prices = [float(candle.close) for candle in ohlcv[-short_period:]]
    longer_prices = [float(candle.close) for candle in ohlcv[-long_period:]]

    short_avg = sum(recent_prices) / len(recent_prices)
    long_avg = sum(longer_prices) / len(longer_prices)

    # Determine trend
    if short_avg > long_avg * 1.02:  # 2% threshold
        return 'uptrend'
    elif short_avg < long_avg * 0.98:
        return 'downtrend'
    else:
        return 'sideways'
```

**2. Update Bull/Bear agents** to use shared utility:
```python
# In bull.py and bear.py
from trading.utils.momentum import calculate_price_momentum, detect_trend

# Replace duplicated momentum calculation with:
momentum = calculate_price_momentum(ohlcv, periods=5)
trend = detect_trend(ohlcv, short_period=5, long_period=20)
```

**What to avoid:**
- Don't keep the duplicated 48-74 line blocks in Bull/Bear agents (extract completely)
- Don't change the algorithm logic during extraction (just consolidate existing code)
- Don't introduce new dependencies (use only standard library and existing OHLCV structures)

**Why these choices:**
- DRY principle: Single source of truth for momentum calculations
- Maintainability: Bug fixes apply to both Bull and Bear automatically
- Testability: Can unit test momentum utilities independently
- Reusability: Other agents can use these utilities if needed
  </action>
  <verify>
1. Utility module created: `trading/utils/momentum.py` exists
2. Functions work: `python -c "from trading.utils.momentum import calculate_price_momentum; print('OK')"` succeeds
3. Duplication removed: `grep -n "price momentum" trading/agents/bull.py trading/agents/bear.py` shows no remaining duplicates
4. Imports work: Both Bull and Bear agents import from trading.utils.momentum
  </verify>
  <done>
- Momentum utility module created
- Duplicate logic consolidated into reusable functions
- Bull/Bear agents use shared utilities
- No duplicated momentum calculation code remains
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance Bull/Bear agents with multi-factor technical analysis</name>
  <files>trading/agents/bull.py, trading/agents/bear.py</files>
  <action>
Replace oversimplified 2% momentum detection with sophisticated multi-factor analysis using QuantAnalyst indicators.

**1. In BullAgent - Replace execute() logic:**
```python
async def execute(self, context):
    """
    Bullish analysis using multi-factor technical indicators.
    Looks for: RSI oversold, MACD bullish crossover, price near lower Bollinger Band.
    """
    # Get indicators from QuantAnalyst
    indicators = context.get('quant_analyst', {}).get('indicators', {})
    if not indicators:
        return {'vote': 0.0, 'confidence': 0.0, 'reason': 'No indicator data'}

    # Extract indicator signals
    rsi = indicators.get('rsi', {})
    macd = indicators.get('macd', {})
    bb = indicators.get('bollinger', {})

    # Calculate bullish factors (each contributes to confidence)
    factors = []
    reasons = []

    # Factor 1: RSI oversold (strong bullish signal)
    if rsi.get('oversold', False):
        factors.append(0.4)  # 40% weight
        reasons.append(f"RSI oversold ({rsi['value']:.1f})")
    elif rsi.get('value', 50) < 50:
        factors.append(0.2)  # Mildly bullish
        reasons.append(f"RSI below neutral ({rsi['value']:.1f})")

    # Factor 2: MACD bullish crossover
    if macd.get('bullish', False):
        factors.append(0.3)  # 30% weight
        reasons.append(f"MACD bullish crossover (hist={macd['histogram']:.4f})")

    # Factor 3: Price near lower Bollinger Band (reversion opportunity)
    if bb.get('position') in ['lower', 'middle_lower']:
        factors.append(0.3)  # 30% weight
        reasons.append(f"Price near lower BB ({bb['position']})")

    # Calculate overall confidence
    confidence = min(sum(factors), 1.0)  # Cap at 1.0

    # Vote: Bullish if confidence > threshold
    vote = 1.0 if confidence > 0.3 else 0.0

    return {
        'vote': vote,
        'confidence': confidence,
        'direction': 'bullish' if vote > 0 else 'neutral',
        'factors': reasons,
        'reason': '; '.join(reasons) if reasons else 'No bullish signals'
    }
```

**2. In BearAgent - Replace execute() logic:**
```python
async def execute(self, context):
    """
    Bearish analysis using multi-factor technical indicators.
    Looks for: RSI overbought, MACD bearish crossover, price near upper Bollinger Band.
    """
    # Get indicators from QuantAnalyst
    indicators = context.get('quant_analyst', {}).get('indicators', {})
    if not indicators:
        return {'vote': 0.0, 'confidence': 0.0, 'reason': 'No indicator data'}

    # Extract indicator signals
    rsi = indicators.get('rsi', {})
    macd = indicators.get('macd', {})
    bb = indicators.get('bollinger', {})

    # Calculate bearish factors (each contributes to confidence)
    factors = []
    reasons = []

    # Factor 1: RSI overbought (strong bearish signal)
    if rsi.get('overbought', False):
        factors.append(0.4)  # 40% weight
        reasons.append(f"RSI overbought ({rsi['value']:.1f})")
    elif rsi.get('value', 50) > 50:
        factors.append(0.2)  # Mildly bearish
        reasons.append(f"RSI above neutral ({rsi['value']:.1f})")

    # Factor 2: MACD bearish crossover
    if not macd.get('bullish', True):  # Bearish when not bullish
        factors.append(0.3)  # 30% weight
        reasons.append(f"MACD bearish crossover (hist={macd['histogram']:.4f})")

    # Factor 3: Price near upper Bollinger Band (overextension)
    if bb.get('position') in ['upper', 'middle_upper']:
        factors.append(0.3)  # 30% weight
        reasons.append(f"Price near upper BB ({bb['position']})")

    # Calculate overall confidence
    confidence = min(sum(factors), 1.0)  # Cap at 1.0

    # Vote: Bearish if confidence > threshold
    vote = -1.0 if confidence > 0.3 else 0.0

    return {
        'vote': vote,
        'confidence': confidence,
        'direction': 'bearish' if vote < 0 else 'neutral',
        'factors': reasons,
        'reason': '; '.join(reasons) if reasons else 'No bearish signals'
    }
```

**What to avoid:**
- Don't remove the entire agent structure (keep BaseAgent inheritance, async execute signature)
- Don't hardcode indicator thresholds without explanation (document why RSI 30/70, why factor weights)
- Don't ignore missing indicator data (handle KeyError gracefully with fallback)
- Don't make Bull/Bear identical (they should look for opposite signals)

**Why these choices:**
- Multi-factor approach: More robust than single indicator (reduces false signals)
- Factor weighting: RSI overbought/oversold gets highest weight (proven reversal indicator)
- Confidence scoring: Additive factors create nuanced confidence levels (not just binary)
- Threshold voting: Only vote if confidence > 0.3 (prevents weak signals from influencing decision)
- Transparency: Return factor breakdown for debugging and decision auditing
  </action>
  <verify>
1. Simplified logic removed: `grep -n "2%" trading/agents/bull.py trading/agents/bear.py` shows no hardcoded 2% checks
2. Multi-factor analysis present: Code references RSI, MACD, Bollinger Bands
3. Test with real data: Run Bull/Bear agents with QuantAnalyst context, verify non-neutral votes
4. Confidence scores vary: Verify confidence isn't always 0.0 or 1.0 (should have nuanced values)
  </verify>
  <done>
- Bull/Bear agents no longer use 2% momentum heuristic
- Multi-factor technical analysis using RSI, MACD, Bollinger Bands
- Sophisticated confidence scoring based on signal alignment
- Transparent factor breakdown for decision auditing
- Adversarial framework now operates on proper technical analysis
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Momentum utility module created and imported
- [ ] No duplicate momentum calculation in Bull/Bear agents
- [ ] Bull agent uses multi-factor bullish analysis
- [ ] Bear agent uses multi-factor bearish analysis
- [ ] Both agents return confidence scores based on indicator alignment
- [ ] Factor breakdown included in agent output
- [ ] No hardcoded 2% momentum checks remain
</verification>

<success_criteria>

- Both tasks completed successfully
- Duplicate code eliminated via shared utilities
- Bull/Bear agents use sophisticated technical analysis
- Multi-factor confidence scoring implemented
- Phase 2 (Complete Agent Implementations) COMPLETE
- Ready for Phase 3 (Comprehensive Testing)
</success_criteria>

<output>
After completion, create `.planning/phases/02-complete-agent-implementations/02-03-SUMMARY.md`:

# Phase 2 Plan 3: Bull/Bear Enhancement Summary

**[One-liner describing what shipped]**

## Accomplishments

- Extracted duplicate momentum logic to shared utility module
- Enhanced Bull/Bear agents with multi-factor technical analysis
- [Additional accomplishments]

## Files Created/Modified

- `trading/utils/momentum.py` (new) - Shared momentum calculation utilities
- `trading/agents/bull.py` - Multi-factor bullish analysis with TA indicators
- `trading/agents/bear.py` - Multi-factor bearish analysis with TA indicators

## Decisions Made

- Factor weighting: RSI (40%), MACD (30%), Bollinger Bands (30%)
- Voting threshold: Confidence > 0.3 required for non-neutral vote
- Additive confidence: Multiple aligned signals increase confidence
- [Other decisions]

## Deviations from Plan

[Document any deviations using deviation rules, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Verification Results

[Results of verification checklist]

## Next Step

**Phase 2 Complete!** All agent implementations finished (QuantAnalyst, Predict, Bull, Bear).

Ready for Phase 3: Comprehensive Testing
</output>
