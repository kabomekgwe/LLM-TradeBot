---
phase: 02-complete-agent-implementations
plan: 01
type: execute
---

<objective>
Integrate TA-Lib technical indicators (RSI, MACD, Bollinger Bands) in QuantAnalystAgent.

Purpose: Replace placeholder neutral signals with real technical analysis, providing foundation for Bull/Bear agents and ML predictions.
Output: QuantAnalystAgent returns structured indicator signals based on market data.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-foundation/01-01-SUMMARY.md
@.planning/phases/01-security-foundation/01-02-SUMMARY.md
@.planning/phases/01-security-foundation/01-03-SUMMARY.md
@.planning/phases/02-complete-agent-implementations/DISCOVERY.md

**Codebase constraints:**
- Python 3.7+ with asyncio
- TA-Lib library already in requirements.txt
- Agent pattern: `async def execute(context) -> dict`
- Context pattern: Dictionary with OHLCV data from DataSyncAgent
- Return structure: Signals dict consumed by Bull/Bear/Predict agents

**From codebase analysis (CONCERNS.md):**
- **Current issue**: QuantAnalystAgent returns hardcoded neutral signals (`trading/agents/quant_analyst.py:18,59`)
- **Why**: MVP phase implementation, full features deferred
- **Impact**: 8-agent system makes decisions without proper technical analysis

**From DISCOVERY.md:**
- TA-Lib requires numpy arrays (convert from OHLCV candles)
- Minimum data requirements: RSI=14, MACD=26, BB=20 periods
- NaN handling needed for early values
- Returns: RSI value, MACD line/signal/histogram, Bollinger upper/middle/lower bands

**Prior work:**
- Phase 1 established security foundation (credentials, validation, state persistence)
- DataSyncAgent fetches multi-timeframe OHLCV (limit=100, sufficient for indicators)

**Why this matters:**
QuantAnalyst is the foundation for all technical analysis in the system. Bull/Bear agents and ML predictions depend on these signals. Without real indicators, the entire 8-agent decision framework operates on placeholder data.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement TA-Lib indicators in QuantAnalystAgent</name>
  <files>trading/agents/quant_analyst.py</files>
  <action>
Replace placeholder logic in `execute()` method with real TA-Lib calculations:

**1. Extract close prices from context:**
```python
import numpy as np

# Get OHLCV from DataSyncAgent
ohlcv = context.get('ohlcv_data', {}).get('5m', [])  # 5-minute candles
if not ohlcv or len(ohlcv) < 26:  # MACD needs 26 periods minimum
    return {'error': 'Insufficient data for indicators', 'signals': 'neutral'}

# Convert to numpy array
close_prices = np.array([float(candle.close) for candle in ohlcv])
```

**2. Calculate RSI (14-period):**
```python
import talib

rsi = talib.RSI(close_prices, timeperiod=14)
rsi_current = rsi[-1] if not np.isnan(rsi[-1]) else 50.0  # Default to neutral if NaN

# Determine signal
rsi_signal = 'overbought' if rsi_current > 70 else 'oversold' if rsi_current < 30 else 'neutral'
```

**3. Calculate MACD (12, 26, 9):**
```python
macd, macdsignal, macdhist = talib.MACD(close_prices, fastperiod=12, slowperiod=26, signalperiod=9)

macd_current = macd[-1] if not np.isnan(macd[-1]) else 0.0
signal_current = macdsignal[-1] if not np.isnan(macdsignal[-1]) else 0.0
hist_current = macdhist[-1] if not np.isnan(macdhist[-1]) else 0.0

# Determine trend
macd_signal = 'bullish' if macd_current > signal_current else 'bearish'
```

**4. Calculate Bollinger Bands (20-period, 2 std dev):**
```python
upperband, middleband, lowerband = talib.BBANDS(close_prices, timeperiod=20, nbdevup=2, nbdevdn=2, matype=0)

upper = upperband[-1] if not np.isnan(upperband[-1]) else close_prices[-1]
middle = middleband[-1] if not np.isnan(middleband[-1]) else close_prices[-1]
lower = lowerband[-1] if not np.isnan(lowerband[-1]) else close_prices[-1]
current_price = close_prices[-1]

# Determine position
if current_price > middle:
    bb_position = 'upper' if current_price > (middle + (upper - middle) * 0.5) else 'middle_upper'
else:
    bb_position = 'lower' if current_price < (middle - (middle - lower) * 0.5) else 'middle_lower'
```

**5. Return structured signals:**
```python
return {
    'indicators': {
        'rsi': {
            'value': float(rsi_current),
            'signal': rsi_signal,
            'overbought': rsi_current > 70,
            'oversold': rsi_current < 30
        },
        'macd': {
            'macd': float(macd_current),
            'signal': float(signal_current),
            'histogram': float(hist_current),
            'trend': macd_signal,
            'bullish': macd_current > signal_current
        },
        'bollinger': {
            'upper': float(upper),
            'middle': float(middle),
            'lower': float(lower),
            'current_price': float(current_price),
            'position': bb_position,
            'bandwidth': float((upper - lower) / middle) if middle != 0 else 0.0
        }
    },
    'overall_signal': rsi_signal  # Backward compatibility with existing code expecting 'overall_signal'
}
```

**What to avoid:**
- Don't use pandas Series (TA-Lib requires numpy arrays)
- Don't ignore NaN values (causes downstream errors) - provide sensible defaults
- Don't hardcode indicator parameters (use standard values: RSI=14, MACD=12/26/9, BB=20)
- Don't return just the indicator values without interpretation (include signal strings like 'bullish', 'overbought')

**Why these choices:**
- Numpy arrays: TA-Lib requirement, 2-4x faster than alternatives
- NaN handling: Early periods lack data, defaulting to neutral prevents crashes
- Structured output: Enables Bull/Bear agents to make nuanced decisions (not just neutral)
- Backward compatibility: Keep 'overall_signal' key for any existing code
  </action>
  <verify>
1. Import check: `python -c "import talib; print('TA-Lib OK')"` succeeds
2. Manual test: Run QuantAnalystAgent with real OHLCV data, verify non-neutral signals returned
3. Verify output structure: Check returned dict contains 'indicators' with 'rsi', 'macd', 'bollinger' keys
4. NaN handling: Test with minimal data (10 candles), verify defaults instead of NaN values
  </verify>
  <done>
- QuantAnalystAgent no longer returns hardcoded neutral signals
- RSI, MACD, Bollinger Bands calculated from real market data
- Output includes both raw values and interpreted signals (bullish/bearish/overbought/oversold)
- NaN values handled gracefully with neutral defaults
- Structure supports Bull/Bear agent consumption and ML feature extraction
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TA-Lib import works in quant_analyst.py
- [ ] RSI calculation returns values in [0, 100] range
- [ ] MACD returns macd, signal, histogram with proper sign
- [ ] Bollinger Bands return upper > middle > lower
- [ ] NaN handling prevents crashes with minimal data
- [ ] Output structure matches documented format
</verification>

<success_criteria>

- Task completed successfully
- QuantAnalystAgent returns real indicator values
- No hardcoded neutral signals remain
- Structured output enables downstream agent decisions
- Ready for Plan 02-02 (LightGBM integration)
</success_criteria>

<output>
After completion, create `.planning/phases/02-complete-agent-implementations/02-01-SUMMARY.md`:

# Phase 2 Plan 1: TA-Lib Integration Summary

**[One-liner describing what shipped]**

## Accomplishments

- Integrated TA-Lib indicators (RSI, MACD, Bollinger Bands) in QuantAnalystAgent
- [Additional accomplishments]

## Files Created/Modified

- `trading/agents/quant_analyst.py` - Replaced placeholder logic with TA-Lib calculations

## Decisions Made

[Key decisions and rationale, or "None"]

## Deviations from Plan

[Document any deviations using deviation rules, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Verification Results

[Results of verification checklist]

## Next Step

Ready for 02-02-PLAN.md (LightGBM Model Training & Integration)
</output>
