---
phase: 07-deep-learning-models
plan: 07-03-independent-strategy-integration
type: execute
---

<objective>
Integrate trained deep learning models (BiLSTM and Transformer) into an independent trading strategy that runs parallel to the existing ensemble system with separate portfolio management.

**Purpose:** Create production-ready deep learning trading strategy with its own risk management, position sizing, and performance tracking - completely independent from the Phase 6 ensemble framework.

**Output:**
- Deep learning trading strategy class (trading/ml/deep_learning/deep_learning_strategy.py)
- Model persistence utilities (trading/ml/deep_learning/persistence.py)
- Independent strategy CLI (trading/cli_deep_learning.py)
- Integration tests (tests/test_deep_learning_strategy.py)
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-deep-learning-models/07-RESEARCH.md
@.planning/phases/07-deep-learning-models/07-CONTEXT.md
@.planning/phases/07-deep-learning-models/07-01-PLAN.md
@.planning/phases/07-deep-learning-models/07-02-PLAN.md
</context>

<tasks>
<task type="auto">
  <name>Task 1: Create Model Persistence and Deep Learning Strategy Class</name>

  <files>
  - trading/ml/deep_learning/persistence.py
  - trading/ml/deep_learning/deep_learning_strategy.py
  - trading/ml/deep_learning/__init__.py (update exports)
  </files>

  <action>
  **1.1 Implement ModelPersistence (trading/ml/deep_learning/persistence.py):**

  **Security-hardened model loading:**
  - Use PyTorch native .pth format (state_dict only)
  - Validate model architecture before loading
  - Fail gracefully if model files missing

  Create class that loads BiLSTM and Transformer models using only PyTorch's state_dict serialization (which uses native format, not unsafe serialization). The class should initialize model architecture first, then load trained weights.

  **WHY this prevents security issues:**
  - PyTorch state_dict is safe: Only contains model weights/parameters
  - No arbitrary code execution possible
  - Architecture defined in code, not loaded from file

  **1.2 Implement DeepLearningStrategy (trading/ml/deep_learning/deep_learning_strategy.py):**

  **Key design from 07-CONTEXT.md:**
  - Independent from ensemble framework (NO integration with RegimeAwareEnsemble)
  - Parallel execution with separate portfolio
  - Uses best performing model (BiLSTM or Transformer) based on compare_models.py results
  - Hybrid input: raw sequences + 86 features

  **Architecture:**
  - Separate portfolio management (no shared positions with ensemble)
  - Separate risk controls (independent RiskAudit, PositionManager)
  - Reuses Phase 5 feature engineering (86 features)
  - Reuses Phase 4 logging and exceptions
  - Loads trained model via ModelPersistence
  - Generates predictions using DataPreprocessor from Plan 07-01

  **Prediction flow:**
  1. Fetch recent OHLCV candles (sequence_length + buffer)
  2. Engineer 86 features using Phase 5 pipeline
  3. Create sequence using DataPreprocessor
  4. Run inference with trained model (BiLSTM or Transformer)
  5. Convert probability to signal (buy/sell/neutral)
  6. Apply risk checks (independent from ensemble)
  7. Execute trade if signal strong and risk passes

  **WHY this architecture:**
  - Independent from ensemble: NO shared positions, NO shared risk budget (07-CONTEXT.md line 66-78)
  - Separate portfolio management: Clear performance attribution
  - Parallel execution: Allows A/B testing vs ensemble
  - Reuses Phase 5 features: 86 engineered features
  - Reuses Phase 4 risk management: position_manager, risk_audit

  **1.3 Update __init__.py exports**
  </action>

  <verify>
  ```bash
  # Verify imports work
  python3 -c "
  from trading.ml.deep_learning.persistence import ModelPersistence
  from trading.ml.deep_learning.deep_learning_strategy import DeepLearningStrategy
  print('âœ“ Strategy imports work')
  "

  # Test ModelPersistence (without trained model)
  python3 -c "
  from trading.ml.deep_learning.persistence import ModelPersistence
  from pathlib import Path

  persistence = ModelPersistence()
  lstm_model = persistence.load_lstm()  # Should return None if not trained
  print(f'âœ“ ModelPersistence works (lstm_model={lstm_model})')
  "
  ```
  </verify>

  <done>
  - ModelPersistence class created with security-hardened loading (state_dict only)
  - DeepLearningStrategy class created with independent portfolio management
  - Strategy runs in parallel to ensemble (separate risk budget, separate positions)
  - Reuses Phase 5 features (86 engineered features)
  - Reuses Phase 4 risk management (PositionManager, RiskAudit)
  - Verification passes: imports work, persistence works
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Independent Strategy CLI and Integration</name>

  <files>
  - trading/cli_deep_learning.py
  - trading/ml/deep_learning/__init__.py (ensure all exports)
  </files>

  <action>
  **2.1 Implement cli_deep_learning.py:**

  Independent CLI for running deep learning strategy (separate from existing CLI):

  Features:
  - Argparse with --model flag (lstm or transformer)
  - Loads TradingConfig from environment
  - Initializes CCXTProvider
  - Creates DeepLearningStrategy instance
  - Runs strategy.execute_strategy() in async loop
  - Handles KeyboardInterrupt gracefully
  - Uses Phase 4 structured logging

  **WHY separate CLI:**
  - Independent execution: Can run alongside existing ensemble CLI
  - Model selection: Choose best performer (BiLSTM or Transformer)
  - Clear separation: No confusion with ensemble system

  **Usage:**
  ```bash
  python trading/cli_deep_learning.py --model lstm
  python trading/cli_deep_learning.py --model transformer
  ```

  **2.2 Ensure all __init__.py exports are complete**

  Update trading/ml/deep_learning/__init__.py to export:
  - BiLSTMClassifier, TransformerClassifier (models)
  - DataPreprocessor, TimeSeriesDataset (data)
  - DeepLearningStrategy, ModelPersistence (strategy)
  </action>

  <verify>
  ```bash
  # Verify CLI imports work
  python3 -c "
  from trading.cli_deep_learning import main
  print('âœ“ CLI imports work')
  "

  # Test CLI help
  python3 trading/cli_deep_learning.py --help

  # Test imports from trading.ml.deep_learning
  python3 -c "
  from trading.ml.deep_learning import (
      BiLSTMClassifier,
      TransformerClassifier,
      DataPreprocessor,
      TimeSeriesDataset,
      DeepLearningStrategy,
      ModelPersistence
  )
  print('âœ“ All deep_learning exports work')
  "
  ```
  </verify>

  <done>
  - cli_deep_learning.py created with argparse (--model lstm/transformer)
  - CLI runs independently from ensemble system
  - All __init__.py exports verified
  - Verification passes: imports work, CLI help works
  - Ready to run after models are trained
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Integration Tests for Deep Learning Strategy</name>

  <files>
  - tests/test_deep_learning_strategy.py
  </files>

  <action>
  **3.1 Implement test_deep_learning_strategy.py:**

  Comprehensive tests for deep learning pipeline:

  **Test classes:**

  1. **TestModelPersistence:**
     - test_save_load_lstm: Save and load BiLSTM model, verify parameters match
     - test_save_load_transformer: Save and load Transformer model
     - test_load_nonexistent_model: Graceful failure when model doesn't exist (returns None)

  2. **TestDataPreprocessor:**
     - test_create_sequences: Verify sequence creation with sliding window
     - test_chronological_split_no_shuffle: Verify chronological order (train < validation < test)
     - test_scaler_fit_only_on_train: Verify scaler raises error if fit_scaler=False before fitting

  3. **TestTimeSeriesDataset:**
     - test_dataset_indexing: Verify dataset returns correct shapes
     - test_dataset_length: Verify __len__ works

  4. **TestDeepLearningStrategy (with mocks):**
     - test_prediction_format: Verify prediction returns {signal, confidence, model, prediction_time_ms}
     - test_independent_execution: Verify separate PositionManager/RiskAudit instances (no shared state)

  **Test coverage targets:**
  - Model persistence: 100%
  - Data preprocessing: 100%
  - Dataset: 100%
  - Strategy: 80% (async mocking complex)

  **Key assertions:**
  - Chronological split: y_train[0] < y_train[-1] < y_validation[0] < y_test[0]
  - Scaler fitting: Raises ValueError if used before fitting
  - No shuffle: Verify temporal order maintained
  - Independent execution: No shared instances with ensemble

  **3.2 Run tests and verify passing**
  </action>

  <verify>
  ```bash
  # Run deep learning tests
  pytest tests/test_deep_learning_strategy.py -v

  # Check test coverage
  pytest tests/test_deep_learning_strategy.py --cov=trading.ml.deep_learning --cov-report=term-missing
  ```
  </verify>

  <done>
  - test_deep_learning_strategy.py created with comprehensive tests
  - Tests cover: model persistence, data preprocessing, dataset, strategy
  - Chronological split verification (no shuffle)
  - Scaler fitting verification (fit only on train)
  - Independent execution verification (no shared state with ensemble)
  - Verification passes: tests run, coverage targets met
  </done>
</task>
</tasks>

<verification>
**Overall Plan Verification:**

1. **Architecture Compliance:**
   - DeepLearningStrategy is INDEPENDENT from ensemble (separate portfolio, separate risk budget)
   - Parallel execution (can run alongside ensemble CLI)
   - Security-hardened persistence (state_dict only, safe serialization)

2. **Integration:**
   - Reuses Phase 5 features (86 engineered features)
   - Reuses Phase 4 risk management (PositionManager, RiskAudit)
   - Reuses Phase 4 logging (structured logging)
   - Reuses DataPreprocessor from Plan 07-01 (chronological splits)

3. **Independence Verification:**
   - Separate CLI (cli_deep_learning.py vs existing CLI)
   - Separate PositionManager instance (no shared positions)
   - Separate RiskAudit instance (no shared risk budget)
   - NO imports from trading.ml.ensemble

4. **Run Strategy:**
   ```bash
   # After training models
   python trading/cli_deep_learning.py --model lstm
   # OR
   python trading/cli_deep_learning.py --model transformer
   ```

5. **Expected Outcome:**
   - Strategy runs independently
   - Predictions generated < 500ms (MacBook CPU)
   - Separate positions from ensemble
   - Separate risk controls
   - Tests pass with > 80% coverage
</verification>

<success_criteria>
1. âœ… ModelPersistence loads models securely (state_dict only)
2. âœ… DeepLearningStrategy class created with independent architecture
3. âœ… CLI created with model selection (--model lstm/transformer)
4. âœ… Tests created with comprehensive coverage
5. âœ… All imports work
6. âœ… Tests pass
7. ðŸŽ¯ **Integration validation:** Run CLI after training and verify predictions
8. ðŸŽ¯ **Independence validation:** Verify no shared state with ensemble (separate portfolio, separate risk budget)
</success_criteria>

<output>
After completion, create `.planning/phases/07-deep-learning-models/07-03-SUMMARY.md` with:
- Tasks completed
- Architecture decisions (why independent, why separate portfolio, why this integration approach)
- Security considerations (state_dict only persistence)
- Files created/modified
- Test results (coverage, passing tests)
- Integration verification (CLI runs, predictions work)
- Phase 7 completion summary (all 3 plans done, deep learning pipeline ready)
</output>
